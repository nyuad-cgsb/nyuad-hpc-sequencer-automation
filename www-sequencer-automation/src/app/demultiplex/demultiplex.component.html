<div class="row">
  <div class="col-md-12">
    <h2>Start a sequencing job</h2>
  </div>
</div>

<ngx-spinner
  bdColor="rgba(51,51,51,0.8)"
  size="medium"
  color="#fff"
  type="ball-scale-multiple">
  <p style="font-size: 20px; color: white">Validating</p>
</ngx-spinner>

<div class="row">
  <div class="col-md-12">
    <form (ngSubmit)="onSubmit()" id="sequencer-automation-form" #sequencerAutomationForm="ngForm">
      <div id="demultiplexRow" class="row">
        <div class="col-md-12">
          <h2>Demultiplex Args</h2>
          <!--Start workdir-->
          <div class="form-group">
            <label for="inputWorkPath">Work Directory</label>
            <input type="text"
                   name="inputWorkPath"
                   class="form-control"
                   id="inputWorkPath"
                   aria-describedby="workPathHelp"
                   required
                   [(ngModel)]="formResults.workDir"
                   minlength="10"
                   (ngModelChange)="checkDoesDirExist()"
                   placeholder="Enter workPath">
            <small id="workPathHelp" class="form-text text-muted">This path must exist on dalma and be an absolute path.
            </small>
          </div>
          <!--End workdir-->

          <!--Start workdir validation-->
          <div class="row">
            <div class="col-md-12">
              <div class="alert alert-danger" *ngIf="!formResults.isWorkDirValid && formResults.workDir">
                <p>This is not a valid Work Directory. Please ensure you are entering the absolute directory.</p>
              </div>
            </div>
            <div class="col-md-12">
              <div class="alert alert-success" *ngIf="formResults.isWorkDirValid && formResults.workDir">
                <p>This is a valid Work Directory.</p>
              </div>
            </div>
          </div>
          <!--Start workdir validation-->

          <div *ngIf="formResults.isWorkDirValid" class="row">
            <div class="col-md-12">
              <h3>Autogenerated Paths</h3>
              <p>The following paths are autogenerated based on the /work directory, but can be updated as necessary</p>
              <p>Please see the bottom to ensure that the demultiplex command is correct.</p>
              <!--Start scratch dir-->
              <div class="form-group">
                <label for="inputScratchPath">Scratch Directory</label>
                <input type="text"
                       name="inputScratchPath"
                       class="form-control"
                       id="inputScratchPath"
                       aria-describedby="scratchPathHelp"
                       required
                       [(ngModel)]="formResults.scratchDir"
                       (ngModelChange)="createRunId()"
                       minlength="10"
                       placeholder="Enter scratch directory">
              </div>
              <!--End scratch dir-->

              <!--start demultiplex working directory-->
              <div class="form-group">
                <label for="inputDemultiplexWorkingDir">Demultiplex Working Directory (cd)</label>
                <input type="text"
                       name="inputDemultiplexWork"
                       class="form-control"
                       id="inputDemultiplexWorkingDir"
                       aria-describedby="inputDemultiplexWorkingDirHelp"
                       required
                       [(ngModel)]="formResults.demultiplexCurrentWorkDir"
                       (ngModelChange)="createRunId()"
                       minlength="10"
                       placeholder="Enter demultiplex working (cwd) directory">
              </div>
              <!--end demultiplex working directory-->

              <!--start demultiplex run directory-->
              <div class="form-group">
                <label for="inputDemultiplexRunDir">Demultiplex Run Directory (bcl2fastq -R)</label>
                <input type="text"
                       name="inputDemultiplexRunDir"
                       class="form-control"
                       id="inputDemultiplexRunDir"
                       aria-describedby="inputDemultiplexRunDirHelp"
                       required
                       [(ngModel)]="formResults.demultiplexRunDir"
                       (ngModelChange)="createRunId()"
                       minlength="10"
                       placeholder="Enter run directory">
              </div>
              <!--end demultiplex working directory-->

              <!--start samplesheet-->
              <div class="form-group">
                <label for="inputSampleSheet">Absolute Path to Sample Sheet</label>
                <input type="text"
                       name="inputSampleSheet"
                       class="form-control"
                       id="inputSampleSheet"
                       aria-describedby="inputSampleSheetHelp"
                       required
                       [(ngModel)]="formResults.sampleSheet"
                       (ngModelChange)="createRunId()"
                       minlength="10"
                       placeholder="Enter samplesheet">
              </div>
              <!--end demultiplex working directory-->

              <div *ngIf="formResults.demultiplexCommand" class="alert alert-info">
                <p>{{formResults.demultiplexCommand}}</p>
              </div>
            </div>
          </div>

        </div>
      </div>

      <hr>

      <div id="jiraTicketRow" class="row">
        <div class="col-md-12">
          <h2>Jira Ticket</h2>
          <!--Begin : Toggle Use Existing / Create Ticket-->
          <div class="row form-group">
            <div class="col-md-4">
              <strong>Use Existing Ticket?</strong>
            </div>
            <div class="col-md-4">
              <ui-switch name="toggleUseExistingTicket" [(ngModel)]="useExistingTicket"></ui-switch>
            </div>
          </div>
          <!--End : Toggle Use Existing / Create Ticket-->

          <!--Begin: Choose Existing JIRA Ticket-->
          <div *ngIf="useExistingTicket">
            <div class="form-group row">
              <div class="col-md-4">
                <label for="jiraTicket">Existing JIRA Ticket</label>
              </div>
              <div class="col-md-6">
                <input type="text"
                       id="jiraTicket"
                       name="jiraTicket"
                       class="form-control"
                       minlength="4"
                       [(ngModel)]="formResults.jiraTicket"
                       (ngModelChange)="getJiraTicket()"
                       placeholder="Enter jira ticket"
                >
              </div>
            </div>
          </div>
          <!--End: Choose Existing JIRA Ticket-->

          <!--Begin: Create JIRA Ticket-->
          <div *ngIf="!useExistingTicket">
            <div class="form-group">
              <label for="jiraSummary">Summary</label>
              <input type="text"
                     id="jiraSummary"
                     name="jiraSummary"
                     class="form-control"
                     minlength="4"
                     [(ngModel)]="jiraTicket.summary"
                     placeholder="Ticket Summary"
              >
            </div>
            <div class="form-group">
              <label for="jiraDescription">Description</label>
              <input type="text"
                     id="jiraDescription"
                     name="jiraDescription"
                     class="form-control"
                     minlength="4"
                     [(ngModel)]="jiraTicket.description"
                     placeholder="Ticket Description"
              >
            </div>
            <button class="btn btn-primary" (click)="createJiraTicket()">Create JIRA Ticket</button>
          </div>
          <!--End: Create JIRA Ticket-->

          <br>

          <!--Begin Display JIRA Ticket-->
          <div class="row">
            <div class="col-md-12">
              <div *ngIf="formResults.jiraTicketError" class="alert alert-warning">
                <p>Jira Ticket is not valid</p>
              </div>
              <div *ngIf="jiraTicket?.ticketId" class="alert alert-success">
                <p>Jira Ticket is valid</p>
                <strong>Ticket ID: </strong>
                <p>{{jiraTicket?.ticketId}}</p>
                <strong>Summary: </strong>
                <p>{{jiraTicket?.summary}}</p>
                <strong>Description: </strong>
                <p>{{jiraTicket?.description}}</p>
              </div>
            </div>
          </div>
          <!--End Display JIRA Ticket-->
        </div>
      </div>

      <hr>
      <!--Optional Project Name-->
      <div  class="row">
        <div class="col-md-12">
          <h2>Project Name</h2>
          <div class="form-group">
            <label for="projectName">Project</label>
            <input type="text"
                   name="projectName"
                   class="form-control"
                   id="projectName"
                   aria-describedby="projectNameHelp"
                   [(ngModel)]="formResults.projectName"
                   minlength="10"
                   (ngModelChange)="createRunId()"
                   placeholder="Enter a project name">
            <small id="projectNameHelp" class="form-text text-muted">Optionally, give a project name. This will be inserted to the airflow run id, which is shown in the UI, and displayed on the updates for the JIRA ticket.
            </small>
          </div>
        </div>
      </div>
      <!--Descriptive run name for airflow interface-->

      <!--Descriptive run name for airflow interface-->
      <div *ngIf="formResults.isWorkDirValid && jiraTicket.summary" class="row">
        <div class="col-md-12">
          <div class="alert alert-info">
            <p>{{formResults.runId}}</p>
          </div>
        </div>
      </div>
      <!--Descriptive run name for airflow interface-->

      <hr>
      <!--Begin BioSAILs QC-->
      <div id="biosailsRow" class="row">
        <div class="col-md-12">
          <h2>BioSails Workflows</h2>
          <app-run-biosails-workflow [biosailsWorkflows]="biosails"></app-run-biosails-workflow>
        </div>
      </div>
      <!--End BioSAILs QC-->

      <!--This needs some kind of observable-->
      <button type="submit" class="btn btn-primary"
              [disabled]="!sequencerAutomationForm.form.valid && !isFormValid()">
        Submit
      </button>
    </form>
  </div>
</div>

<br>
<br>

<div *ngIf="submitted">
  <div *ngIf="formResults.runUrl" class="alert alert-success">
    <strong>Success: Run Progress Available @</strong><br><a href="{{formResults.runUrl}}">Run
    Id {{formResults.runId}}</a>
    <br>
    <strong>JIRA Ticket @</strong><br><a href="{{formResults.jiraUrl}}">JIRA Ticket
    {{formResults.jiraTicket}}</a>
  </div>
  <div *ngIf="error" class="alert alert-danger">
    <strong>Error</strong>
    {{error | json}}
  </div>
</div>

